# Registry-GC Service

[English](README.md) | **–†—É—Å—Å–∫–∏–π**

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ Docker Registry. –°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –æ—á–∏—Å—Ç–∫–∏:
- **Webhook-—Ç—Ä–∏–≥–≥–µ—Ä—ã GC**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç garbage collection –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤
- **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ç–µ–≥–æ–≤**: –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ —Ç–µ–≥–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –≤–µ—Ä—Å–∏–π
- **–†—É—á–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã**: –û—á–∏—Å—Ç–∫–∞ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é —á–µ—Ä–µ–∑ HTTP API

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üîÑ **Webhook-—Ç—Ä–∏–≥–≥–µ—Ä—ã GC**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç garbage collection –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤
- üìÖ **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ç–µ–≥–æ–≤**: –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 24—á)
- üè∑Ô∏è **–£–º–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞–º–∏**: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç N –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç–µ–≥–æ–≤, —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å —É—á–µ—Ç–æ–º semver
- ‚è±Ô∏è **Debounce**: –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤ –æ–¥–∏–Ω –∑–∞–ø—É—Å–∫ GC (–∑–∞–¥–µ—Ä–∂–∫–∞ 1 –º–∏–Ω—É—Ç–∞)
- üîß **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã**: –†—É—á–Ω–æ–π GC, —Ä—É—á–Ω–æ–π prune+GC –∏ webhook —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
- üîê **–°–µ–ª–µ–∫—Ç–∏–≤–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: Basic Auth —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ç–µ–≥–æ–≤, –Ω–µ –¥–ª—è GC
- ‚ö° **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ—Ä–∫–µ—Ä–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–≥–æ–≤
- üõ°Ô∏è **Graceful shutdown**: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –∏ –æ—Ç–º–µ–Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞

```bash
# –°–±–æ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ
docker build -t registry-gc-listener:latest .

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞ –∏–∑ registry
docker pull r.zaitsv.dev/go-registry-garbage:latest
```

### 2. Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```yaml
version: '3.8'

services:
  registry-ui:
    image: joxit/docker-registry-ui:main
    environment:
      - SINGLE_REGISTRY=true
      - REGISTRY_TITLE=My Registry
      - DELETE_IMAGES=true
      - SHOW_CONTENT_DIGEST=true
      - NGINX_PROXY_PASS_URL=http://registry-server:5000
      - SHOW_CATALOG_NB_TAGS=true
      - CATALOG_MIN_BRANCHES=1
      - CATALOG_MAX_BRANCHES=1
      - TAGLIST_PAGE_SIZE=100
      - REGISTRY_SECURED=false
      - CATALOG_ELEMENTS_LIMIT=1000
    networks: [registry-net]

  registry-server:
    image: registry:2.8.2
    environment:
      REGISTRY_STORAGE_DELETE_ENABLED: "true"
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Origin: "[http://registry-ui]"
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Methods: "[HEAD,GET,OPTIONS,DELETE]"
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Credentials: "[true]"
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Headers: "[Authorization,Accept,Cache-Control]"
      REGISTRY_HTTP_HEADERS_Access-Control-Expose-Headers: "[Docker-Content-Digest]"
    volumes:
      - ./registry-data:/var/lib/registry
      - ./registry-config/config.yml:/etc/docker/registry/config.yml:ro
    networks: [registry-net]

  registry-gc:
    image: r.zaitsv.dev/go-registry-garbage:latest
    depends_on: [registry-server]
    environment:
      - REGISTRY_URL=http://registry-server:5000
      - KEEP_N=10
      - WORKERS=8
      # - REGISTRY_USER=admin
      # - REGISTRY_PASS=password
    volumes:
      - ./registry-data:/var/lib/registry
      - ./registry-config/config.yml:/etc/docker/registry/config.yml:ro
    ports:
      - "8080:8080"
    networks: [registry-net]

networks:
  registry-net:
    driver: bridge
```

### 3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Registry

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `registry-config/config.yml`:

```yaml
version: 0.1
log:
  fields:
    service: registry

storage:
  cache:
    blobdescriptor: inmemory
  filesystem:
    rootdirectory: /var/lib/registry
  delete:
    enabled: true  # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã GC

http:
  addr: :5000
  headers:
    X-Content-Type-Options: [nosniff]

health:
  storagedriver:
    enabled: true
    interval: 10s
    threshold: 3

notifications:
  endpoints:
    - name: gc-listener
      url: http://registry-gc:8080/events
      timeout: 500ms
      threshold: 3
      backoff: 1s
```

## HTTP API

| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å      | –û–ø–∏—Å–∞–Ω–∏–µ                    | –û—Ç–≤–µ—Ç              | –¢—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é |
|-------|-----------|-----------------------------|--------------------|---------------------|
| POST  | `/events` | Webhook –æ—Ç Docker Registry  | `202 Accepted`     | –ù–µ—Ç                 |
| POST  | `/gc`     | –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ GC           | `GC started`       | –ù–µ—Ç                 |
| POST  | `/prune`  | –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ prune+GC     | `prune+GC started` | –î–∞*                 |

*–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ `/prune`, –∫–æ–≥–¥–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã `REGISTRY_USER`/`REGISTRY_PASS`.

### –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```bash
# –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ GC (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
curl -X POST http://localhost:8080/gc

# –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ prune+GC (—Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞)
curl -X POST http://localhost:8080/prune

# –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ webhook —Å–æ–±—ã—Ç–∏—è
curl -X POST http://localhost:8080/events \
  -H "Content-Type: application/json" \
  -d '{"events":[{"action":"delete"}]}'

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
docker logs registry-gc
```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è      | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é                   | –û–ø–∏—Å–∞–Ω–∏–µ                                    |
|-----------------|--------------------------------|---------------------------------------------|
| `REGISTRY_URL`  | `http://registry-server:5000`  | URL Docker Registry –¥–ª—è API –≤—ã–∑–æ–≤–æ–≤. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ GC —Å–µ—Ä–≤–∏—Å–∞ |
| `KEEP_N`        | `10`                           | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç–µ–≥–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∫–∞–∂–¥–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ 0 –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –æ—á–∏—Å—Ç–∫–∏ —Ç–µ–≥–æ–≤ |
| `PRUNE_INTERVAL`| `24h`                          | –ö–∞–∫ —á–∞—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É —Ç–µ–≥–æ–≤. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `0` –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ |
| `WORKERS`       | `8`                            | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–≥–æ–≤. –ë–æ–ª—å—à–µ = –±—ã—Å—Ç—Ä–µ–µ, –Ω–æ –≤—ã—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ |
| `REGISTRY_USER` | -                              | –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è Basic Auth. –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π –æ—á–∏—Å—Ç–∫–∏ —Ç–µ–≥–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |
| `REGISTRY_PASS` | -                              | –ü–∞—Ä–æ–ª—å –¥–ª—è Basic Auth. –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π –æ—á–∏—Å—Ç–∫–∏ —Ç–µ–≥–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |
| `LOG_LEVEL`     | `info`                         | –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: `debug`, `info`, `warn`, `error`. –í—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã GC –∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–µ–≥–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `debug` |

### –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

- **`REGISTRY_URL`**: –°–µ—Ä–≤–∏—Å –¥–æ–ª–∂–µ–Ω –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å API Docker Registry –¥–ª—è:
  - –ü–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ (`/v2/_catalog`)
  - –ü–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–≥–æ–≤ –∫–∞–∂–¥–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (`/v2/{repo}/tags/list`)
  - –ü–æ–ª—É—á–µ–Ω–∏—è –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ (`/v2/{repo}/manifests/{tag}`)
  - –£–¥–∞–ª–µ–Ω–∏—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ (`DELETE /v2/{repo}/manifests/{digest}`)

- **`KEEP_N`**: –£–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª–∏—Ç–∏–∫–æ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–≥–æ–≤. –ù–∞–ø—Ä–∏–º–µ—Ä:
  - `KEEP_N=5` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ 5 –Ω–æ–≤–µ–π—à–∏—Ö —Ç–µ–≥–æ–≤ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
  - `KEEP_N=1` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥ (–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞)
  - `KEEP_N=0` –æ—Ç–∫–ª—é—á–∞–µ—Ç –æ—á–∏—Å—Ç–∫—É —Ç–µ–≥–æ–≤ (—Ç–æ–ª—å–∫–æ garbage collection)

- **`WORKERS`**: –ë–∞–ª–∞–Ω—Å–∏—Ä—É–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –æ—á–∏—Å—Ç–∫–∏ –∏ –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–∏—Å—Ç–µ–º—É:
  - –ë–æ–ª—å—à–µ –≤–æ—Ä–∫–µ—Ä–æ–≤ = –±—ã—Å—Ç—Ä–µ–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
  - –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–æ–≤ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å —Ä–µ–µ—Å—Ç—Ä
  - –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: 4-16 –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ–µ—Å—Ç—Ä–∞

- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ —Ä–µ–µ—Å—Ç—Ä–µ –≤–∫–ª—é—á–µ–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:
  - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏ `REGISTRY_USER`, –∏ `REGISTRY_PASS` –¥–ª—è Basic Auth
  - –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º–∏ –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Ä–µ–µ—Å—Ç—Ä–æ–≤

### –ó–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã

–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω—ã –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –∫–æ–¥–µ –∏ —Ç—Ä–µ–±—É—é—Ç –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:

- **–í—Ä–µ–º—è debounce**: `1 –º–∏–Ω—É—Ç–∞` - –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–±—ã—Ç–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º GC
- **–ü—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É —Ä–µ–µ—Å—Ç—Ä–∞**: `/etc/docker/registry/config.yml` - –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä–µ–µ—Å—Ç—Ä–∞
- **HTTP —Ç–∞–π–º–∞—É—Ç**: `10 —Å–µ–∫—É–Ω–¥` - —Ç–∞–π–º–∞—É—Ç –¥–ª—è –≤—ã–∑–æ–≤–æ–≤ API —Ä–µ–µ—Å—Ç—Ä–∞
- **–ü–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞**: `:8080` - –ø–æ—Ä—Ç –¥–ª—è webhook –∏ —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

–î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `main.go` –∏ –ø–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ Docker –æ–±—Ä–∞–∑.

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### Webhook-—Ç—Ä–∏–≥–≥–µ—Ä—ã GC
1. **Webhook —Å–æ–±—ã—Ç–∏—è**: Registry –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –Ω–∞ `/events` –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤
2. **Debounce**: –°–µ—Ä–≤–∏—Å –∂–¥–µ—Ç 1 –º–∏–Ω—É—Ç—É –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–±—ã—Ç–∏—è —É–¥–∞–ª–µ–Ω–∏—è
3. **Garbage Collection**: –ó–∞–ø—É—Å–∫–∞–µ—Ç `registry garbage-collect --delete-untagged`

### –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ç–µ–≥–æ–≤
1. **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ**: –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ `PRUNE_INTERVAL` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 24—á)
2. **–û—á–∏—Å—Ç–∫–∞ —Ç–µ–≥–æ–≤**: –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ —Ç–µ–≥–∏, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ `KEEP_N` –≤–µ—Ä—Å–∏–π
3. **Garbage Collection**: –ó–∞–ø—É—Å–∫–∞–µ—Ç GC –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ —Ç–µ–≥–æ–≤
4. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: –¢—Ä–µ–±—É–µ—Ç `REGISTRY_USER`/`REGISTRY_PASS` –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ API

### –†—É—á–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã
- **`/gc`**: –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π garbage collection (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
- **`/prune`**: –û—á–∏—Å—Ç–∫–∞ —Ç–µ–≥–æ–≤ + garbage collection (—Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞)

## –ê–ª–≥–æ—Ä–∏—Ç–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ç–µ–≥–æ–≤

–°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É–º–Ω—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É —Ç–µ–≥–æ–≤:
- –ï—Å–ª–∏ —Ç–µ–≥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–º—É –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é (semver) - —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ –≤–µ—Ä—Å–∏—è–º
- –ò–Ω–∞—á–µ - —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç –ª–µ–∫—Å–∏–∫–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–∞–º—ã–µ –Ω–æ–≤—ã–µ —Ç–µ–≥–∏, —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ

## –õ–æ–≥–∏

–ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤ —Å–µ—Ä–≤–∏—Å–∞:

```
INFO[2024-01-15T10:30:00Z] listener started on :8080
INFO[2024-01-15T10:35:00Z] GC scheduled in 1m0s
INFO[2024-01-15T10:36:00Z] ==> prune & GC start
INFO[2024-01-15T10:36:00Z] catalog: 5 repos
INFO[2024-01-15T10:36:01Z] [myapp:v1.0.0] deleted
INFO[2024-01-15T10:36:02Z] [myapp:v1.0.1] deleted
INFO[2024-01-15T10:36:05Z] ==> done in 5.2s
```

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Docker Registry 2.8.2+
- Go 1.24+ (–¥–ª—è —Å–±–æ—Ä–∫–∏)
- –í–∫–ª—é—á–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤ Registry (`storage.delete.enabled: true`)

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License
